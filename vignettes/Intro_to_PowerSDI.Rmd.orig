---
title: "Introduction to PowerSDI"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to PowerSDI}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE,
                      comment = "#>",
                      fig.width = 7,
                      fig.height = 7,
                      fig.align = "center",
                      fig.path = "vignettes/")
```

# Introduction

{PowerSDI} calculates the Standardized Precipitation (SPI; @mckee1993) and Standardized Precipitation-Evapotranspiration (SPEI; @VicenteSerrano2010) indices using gridded-data from the NASA-POWER project.
The package includes functions (`ScientSDI()`, `Reference()`, `Accuracy()` and `PlotData()`), which evaluate how well the drought indices meet their conceptual assumptions.
The `OperatSDI()` function allows users to download NASA-POWER data for specific monitoring periods.
The package adopts a quasi-weekly basic time scale (`quart.month`), allowing for four index calculations per month: days 1 to 7, days 8 to 14, days 15 to 21, and days 22 to 28, 29, 30, or 31 depending on the month.
For instance, if the time scale is set to 4 (`TS = 4`), it corresponds to a moving window with a 1-month length that is calculated four times each month.
If `TS = 48`, the time scale corresponds to a moving window with a 12-month length that is calculated four times each month.
{PowerSDI} uses functions from the {nasapower} [@Sparks2018; @Sparks2023] and {Lmom} [@Hosking2023] packages.

# Basic Instructions: Getting Started

Load the library in your R session.

```{r load-lib}
library("PowerSDI")
```

## Using PlotData() to visually inspect NASA-POWER data

The `PlotData()` function allows a visual inspection of the indices' inputs (precipitation and potential evapotranspiration) obtained from the NASA-POWER project.
These inputs (in millimetres) are show at the 1-quart.month time scale.

## Example 1: Inspecting indices' input for Campinas-SP, Brazil

```{r PlotData}
PlotData(
  lon = -47.3,
  lat = -22.65,
  start.date = "1991-01-01",
  end.date = "2022-12-31"
)
```

## ScientSDI(): Removing suspicious data and calculating the distributions's parameters

The first step of the SPI and SPEI algorithms is to calculate the cumulative probabilities of their input variables [@Guttman1999].
The `ScientSDI()` function estimates the parameters of the gamma, generalized extreme value (GEV), or generalized logistic distributions (GLO) through the L-moments method. This function also allows users to remove suspicious values from the data sample.

## Example 2: Applying the ScientSDI() function for Campinas-SP, Brazil

The plots generated by the `PlotData()` function for Campinas revealed one suspicious rain value larger than 250 mm.
Since this suspicious record represents less than 1% of the data sample, we removed it from the analyses before calculating the parameters of the gamma and GEV distributions.
The PE data showed no suspicious values.

```{r ScientSDI (basic)}
Campinas <- ScientSDI(
  lon = -47.3,
  lat = -22.65,
  start.date = "1991-01-01",
  end.date = "2022-12-31",
  distr = "GEV",
  TS = 4,
  Good = "no",
  RainUplim = 250,
  RainLowlim = NULL,
  PEUplim = NULL,
  PELowlim = NULL
)
```

Check the SDI values.

```{r SDI}
head(Campinas$SDI)
```

Check the DistPar

```{r DistPar}
head(Campinas$DistPar)
```

## Accuracy(): Verifying how well NASA-POWER data actually represent real-world/observed data

A basic assumption related to remote sensing data is that they really represent the "real-world" conditions.
Thus, the `Accuracy()` function calculates the following measures of accuracy: the absolute mean error (AME), root-mean-square-error (RMSE), original (dorig), modified (dmod), refined (dref) Willmott's indices of agreement, and Pearson determination coefficient (R2).

## Example 3: Applying the Accuracy function to compare observed (obs) and NASA-POWER PE data in Campinas-SP, Brazil

In the example below, `data("ObsEst")` contains pairs of observed and estimated potential evapotranspiration (PE) data.
The observed and estimated data were obtained from a weather station in Campinas and from the NASA-POWER project, respectively.
PE was estimated using the Hargreaves & Samani method [@Hargreaves1985].

```{r Accuracy (basic)}
data("ObsEst")

Compare_PE_Cps <- Accuracy(obs_est = ObsEst, conf.int = "No")

Compare_PE_Cps
```

## OperatSDI(): Generating routine operational NASA-SPI and NASA-SPEI estimates

Considering that the parameters of the gamma (SPI) and GEV (SPEI) distributions have already been estimated by the `ScientSDI()` function, we can now use the `OperatSDI()` function to calculate these two indices on a routine basis.

## Example 4: Applying the OperatSDI function to calculate the SPI and SPEI in Campinas-SP, Brazil

The OperatSDI function enables users to download NASA-POWER data only for the period they intend to monitor.

```{r OperatSDI}
parms <- Campinas$DistPar # Obtained in Example 2
SDI <- OperatSDI(
  lon = -47.3,
  lat = -22.65,
  start.date = "2023-08-01",
  end.date = "2023-08-07",
  parms = Campinas$DistPar,
  TS = 4
)

SDI
```

# Not So Basic Instructions:

## The ScientSDI() function: Removing suspicious data and assessing the indices' conceptual assumptions

Standardized indices, both SPI and SPEI are expected to provide spatially consistent interpretations of their values [@Guttman1999].
Therefore, their frequency distributions are expected to always approach the standard normal distribution regardless of the region, season, or time scale at which the indices are calculated [@Wu2006; @Stagge2015; @Blain2017].
In this context, the ScientSDI function calculates two normality-checking procedures described by @Wu2006 and @Stagge2015.
Additionally, the calculation algorithm of the SPI and SPEI relies on fitting a parametric distribution to their input data.
Therefore, the `ScientSDI()` function also applies the widely-used Lilliefors [@Lilliefors1967] and Anderson-Darling [@Anderson1954] goodness-of-fit tests to the gamma and GEV/GLO distributions.
The function `ScientSDI()` allows users to select significance levels ranging from 5 to 10% to run these tests.
Additionally, the SPEI algorithm often uses the generalized extreme value (GEV) or the generalized logistic (GLO) [@VicenteSerrano2010; Begueria2013; @Stagge2015; @Stagge2015a; @VicenteSerrano2015; @Blain2017].
A review of these studies suggests that the performance of these two distributions for calculating the SPEI tends to be similar to each other over most of the range of the index possible values (e.g. -2.0:2:0).
However, these studies also found significant differences between the two probability functions in the lower and upper tails [@VicenteSerrano2015].
In this context, the `ScientSDI()` function also allows the users to choose between these two models when calculating the SPEI.

## Example 5.1: Applying the ScientSDI() function with the GEV and verifying conceptual assumptions (Campinas-SP).

```{r ScientSDI (complete/GEV)}
Campinas.GEV <- ScientSDI(
  lon = -47.3,
  lat = -22.65,
  start.date = "1991-01-01",
  end.date = "2022-12-31",
  distr = "GEV",
  TS = 4,
  Good = "yes",
  sig.level = 0.95,
  RainUplim = 250,
  RainLowlim = NULL,
  PEUplim = NULL,
  PELowlim = NULL
)
```

Check the goodness of fit.

```{r check-fit-gev}
head(Campinas.GEV$GoodFit)
```

Check the normality.

```{r check-normality-gev}
head(Campinas.GEV$Normality)
```

## Example 5.2: Applying the ScientSDI() function with the GLO and verifying conceptual assumptions (Campinas-SP).

```{r ScientSDI (complete/GLO)}
Campinas.GLO <- ScientSDI(
  lon = -47.3,
  lat = -22.65,
  start.date = "1991-01-01",
  end.date = "2022-12-31",
  distr = "GLO",
  TS = 4,
  Good = "yes",
  sig.level = 0.95,
  RainUplim = 250,
  RainLowlim = NULL,
  PEUplim = NULL,
  PELowlim = NULL
)
```

Check the goodness of fit.

```{r check-fit-glo}
head(Campinas.GLO$GoodFit)
```

Check the normality.

```{r check-normality-glo}
head(Campinas.GLO$GoodFit)
```

## The Accuracy() function: Applying the Accuracy function and calculating confidence intervals.

The `Accuracy()` function may also provide confidence intervals (CI) for AME, RMSE, dorig, dmod and dref.
As emphasized by @Willmott1985, the CI specifies a range of values within which these statistics are expected to vary by chance.
Consequently, users can interpret the magnitude of the CI as an indicator of the reliability of the estimated values for the comparison metrics @Willmott1985.
The function allows users to select between 90 and 95% CIs.

## Example 6: Applying the Accuracy function and calculating confidence intervals (Campinas-SP).

```{r Accuracy (complete)}
data("ObsEst")
Compare_PE_Cps_withCI <-
  Accuracy(obs_est = ObsEst,
           conf.int = "yes",
           sig.level = 0.95)
Compare_PE_Cps_withCI
```

# References
